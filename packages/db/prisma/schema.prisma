generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AssignmentTaskType {
  READING
  ESSAY
}

enum UnitType {
  READING
  THESIS
  OUTLINE
  WRITING
  REVISE
}

enum UserAssignmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum UserUnitStatus {
  UNREAD
  ACTIVE
  COMPLETED
}

enum UserInteractionEventType {
  UNIT_OPENED
  UNIT_COMPLETED
  BOOKMARK_TOGGLED
  CHAT_USED
  HINT_USED
  ISSUE_POSTPONED
  ISSUE_RESOLVED
}

enum ScheduleGoalType {
  SOURCES
  THESIS
  OUTLINE
  WRITING
  REVISE
}

enum ScheduleItemStatus {
  PENDING
  DONE
  SKIPPED
}

model User {
  id               String                @id @default(cuid())
  email            String                @unique
  passwordHash     String
  createdAt        DateTime              @default(now())
  refreshTokens    RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  assignmentStates UserAssignmentState[]
  unitStates       UserUnitState[]
  interactionEvents UserInteractionEvent[]
  chatSessions     UnitChatSession[]
  scheduleItems    UserScheduleItem[]
}

model RefreshToken {
  id            String   @id @default(cuid())
  userId        String
  tokenHash     String   @unique
  expiresAt     DateTime
  revokedAt     DateTime?
  rotatedFromId String?
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Assignment {
  id              String                @id @default(cuid())
  title           String
  subject         String
  taskType        AssignmentTaskType
  deadline        DateTime
  seedKey         String                @unique
  active          Boolean               @default(true)
  createdAt       DateTime              @default(now())
  units           AssignmentUnit[]
  assignmentState UserAssignmentState[]
  interactionEvents UserInteractionEvent[]
  scheduleItems   UserScheduleItem[]
}

model AssignmentUnit {
  id          String     @id @default(cuid())
  assignmentId String
  orderIndex  Int
  unitType    UnitType
  title       String
  payload     Json
  targetWords Int?
  createdAt   DateTime   @default(now())

  assignment Assignment    @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  unitStates UserUnitState[]
  interactionEvents UserInteractionEvent[]
  chatSessions UnitChatSession[]
  scheduleItems UserScheduleItem[]

  @@unique([assignmentId, orderIndex])
  @@index([assignmentId])
}

model UserAssignmentState {
  id           String               @id @default(cuid())
  userId       String
  assignmentId String
  currentUnitId String?
  status       UserAssignmentStatus @default(NOT_STARTED)
  lastOpenedAt DateTime?
  completedAt  DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([userId, assignmentId])
  @@index([assignmentId])
}

model UserUnitState {
  id         String         @id @default(cuid())
  userId     String
  unitId     String
  status     UserUnitStatus @default(UNREAD)
  bookmarked Boolean        @default(false)
  content    Json?
  position   Json?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit AssignmentUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId])
  @@index([unitId])
}

model UserInteractionEvent {
  id           String                   @id @default(cuid())
  userId       String
  assignmentId String
  unitId       String?
  eventType    UserInteractionEventType
  meta         Json?
  createdAt    DateTime                 @default(now())

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignment Assignment     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  unit       AssignmentUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([assignmentId, createdAt])
  @@index([unitId])
}

model UnitChatSession {
  id        String   @id @default(cuid())
  userId    String
  unitId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit AssignmentUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  turns UnitChatTurn[]

  @@unique([userId, unitId])
  @@index([unitId, updatedAt])
}

model UnitChatTurn {
  id               String   @id @default(cuid())
  sessionId        String
  userMessage      String
  assistantMessage String
  createdAt        DateTime @default(now())

  session UnitChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

model UserScheduleItem {
  id           String             @id @default(cuid())
  userId       String
  assignmentId String
  dateISO      DateTime
  goalType     ScheduleGoalType
  unitId       String?
  targetWords  Int?
  status       ScheduleItemStatus @default(PENDING)
  title        String
  meta         Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignment Assignment     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  unit       AssignmentUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([userId, dateISO])
  @@index([assignmentId, dateISO])
  @@index([unitId])
}
